# **PID Control**

## Writeup

The purpose of this project is to enable the vehicle to drive around the lake race track with PID controller. I followd the lesson 12 and implemented the code in C++. With hyperparameters given in the quiz of the Section 11(Kp = 0.2, Kd = 3.0, Ki = 0.004), the vehicle was able to drive without getting off the road around minimum speed. So I tried to tune the hyper parameters to make the car drive faster.
---

**PID Control Project**

[//]: # (Image References)

[image1]: ./writeup/1_outoflane.jpg "start_graph"

### Rubric Points
Here I will consider the [rubric points](https://review.udacity.com/#!/rubrics/1972/view). Following criterias were addressed in detail.

---
### 1. Describe the effect each of the P, I, D components had in my implementation.
#### 1.1 Effects of P component
The P component is the component proportional to the cross track error. It has the effect of turning the steering wheel toward the center of the lane when the cte is large. Therefore, if the coefficient of P (Kp) is too small, it slows down the reaction to getting out of the lane. On the other hand, if the Kp is larger, the vehicle oscillate faster as it promptly recovering to the lane center.
I put the following two videos in the writeup folder.
./writeup/1.1_p_00.mp4 Kp = 0
./writeup/1.1_p_09.mp4 Kp = 0.8

#### 1.2 Effects of D component
The D component has the function of preventing overshoot by reducing the effect when the cte becomes small. However, in the lake race trace, the cte may become large because the road is curved. Therefore, if the d component is small, it will not be able to respond quickly to the curve and will run off the road. On the other hand, if the d component is large, it will overreact to the cte generated by the curve, and the direction of the car will change abruptly. As a result, the car will not go out of the lane, but it will be less comfortable to ride.
Below are two videos showing these situations.
./writeup/1.2_d_00.mp4 Kd = 0
./writeup/1.2_d_90.mp4 Kd = 9.0

#### 1.3 Effects of I component
The i component is a component for canceling the systematic bias, and is effective when the angle of the handle is not adjusted to exactly 0. However, when driving on the lake race track, even if Ki was set to 0, no noticeable problem occurred. I think this was because the systematic bias was not set and the impact was difficult to understand because there were few straight roads. On the other hand, increasing Ki caused extra oscillation at the starting point. This was probably due to the overreaction of the car being off center of the lane at the starting point.
I put a following video in the writeup folder.
./writeup/1.3_i_0.02.mp4 Ki = 0.02


### 2. Describe how the final hyperparameters were chosen.
Next, I tuned the hyperparameters. As I was very impressed with the method called twiddle explained in section13, I wanted to implement it. However, even though it was not difficult to implement in the quiz, I could not come up with the implementation suitable for this project easily.
Since the environment did not change in the quiz, the hyperparameters could be tuned by looking at the average of 100 steps. On the other hand, as the road curved along the way for the lake race track, the cte was affected by it. It would be accurate if I averaged over the whole track, but then it would take too much time to tune.

#### 2.1 Manual Tuning
Before talking about how I implemented twiddle, I would like to explane manual tuning.
At first, original parameters given at quiz in Section11 was used. I saved the video of that situation in writeup/suc01.mp4. The vehicle was able to drive without going out of the lane. But that was partly due to the slow speed.

Then I tried to change the speed by increasing the throttle when the steer_value was small.

```
if(steer_value > 0.5 || steer_value < -0.5){
  base_throttle -= 0.01;
}
else if(steer_value < 0.3 && steer_value > -0.3 && base_throttle <= 0.50){
  base_throttle += 0.01;
}
```
As a result, the vehicle was able to drive faster, but sometimes it was out of the lane.

![alt text][image1]

So I manually tuned the parameter to make the car drive safely. Here is the result of my manual tuning. And the resulting movie was saved as ./writeup/suc03.mp4.
```
before:: (Kp = 0.2, Kd = 3.0, Ki = 0.004)
after :: (Kp = 0.2, Kd = 2.0, Ki = 0.002)
```

#### 2.2 Twiddle
After trying various ways to twiddle, I decided to update hyperparameters by 50 steps even though the curve of the road changes every 50 steps. Also, the current error was compaired with the previous error instead of best error. This was because the parameters were not updated all the time because of the accidental best error.

Another difference from the quiz was that the quiz allowed us to run 100 steps in a function "run", but the project had to return to the simulator. Therefore, I introduced a variable called upstate to keep track of whether p was increased or decreased. Also, instead of using for loop, I introduced a variable called ind to update Kp, Ki, Kd in turn.
The implementation of that part is as follows.

```
double err = pid.TotalError();
 if(upstate[ind] && err < prev_err){
   best_err = err;
   dp[ind] *= 1.0;
   ind = (ind+1)%3;
 }else if(upstate[ind] && err >= prev_err){
   p[ind] -= dp[ind];
   upstate[ind] = false;
 }else if(!upstate[ind] && err < prev_err){
   best_err = err;
   dp[ind] *= 1.0;
   ind = (ind+1)%3;
 }else if(!upstate[ind] && err >= prev_err){
   p[ind] += dp[ind];
   dp[ind] *= 0.9;
   upstate[ind] = true;
   ind = (ind+1)%3;
 }

 if(upstate[ind] == true){
   p[ind] += dp[ind];         
   pid.Init(p);
 }else{
   p[ind] -= dp[ind];         
   if(p[ind] < 0.0){
     p[ind] = 0.0;
   }
   pid.Init(p);
 }
 prev_err = err;
```
Even though the tuning did not converge as quiz, the vehicle could drive safely without getting off the lane longer. The tuned hyperparameters were (Kp = 0.15, Kd = 2.6, Ki = 0.0008) and the video of the driving was saved as  ./writeup/suc04.mp4.

### summary
Even though the vehicle could drive around the lake race track without getting off the lane, the drive was very shaky and did not seem confortable. The steering control using deep learning in project04 was smoother. I didn't know if smooth driving could be achieved if the hyperparameters were set more appropriately. Also, I would like to know the proper implementation of twiddle in this situation.
